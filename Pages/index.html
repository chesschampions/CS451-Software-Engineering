<!DOCTYPE html>
<html>
<head>
<title>Checkers Game team7</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<center>

<h1 id="header"></h1>

<h1 id="currentTurn"></h1>

<div id="setup">
<h1>Hi welcome to the checkers game</h1>
<p>Do you want to host or join a game?</p>
    <button onclick="startGame('host')">Host Game</button>
    <button onclick="startGame('join')">Join Game</button>
</div>

<p id="gid"></p>

<div class="container">
    <div class="chessboard">
        <!-- 1st -->
        <div class="black" id="00" onClick="reply_click(this.id)">O</div>
        <div class="white" id="01"></div>
        <div class="black" id="02" onClick="reply_click(this.id)">O</div>
        <div class="white" id="03"></div>
        <div class="black" id="04" onClick="reply_click(this.id)">O</div>
        <div class="white" id="05"></div>
        <div class="black" id="06" onClick="reply_click(this.id)">O</div>
        <div class="white" id="07"></div>

        <!-- 2nd -->
        <div class="white" id="10"></div>
        <div class="black" id="11" onClick="reply_click(this.id)">O</div>
        <div class="white" id="12"></div>
        <div class="black" id="13" onClick="reply_click(this.id)">O</div>
        <div class="white" id="14"></div>
        <div class="black" id="15" onClick="reply_click(this.id)">O</div>
        <div class="white" id="16"></div>
        <div class="black" id="17" onClick="reply_click(this.id)">O</div>

        <!-- 3rd -->
        <div class="black" id="20" onClick="reply_click(this.id)">O</div>
        <div class="white" id="21"></div>
        <div class="black" id="22" onClick="reply_click(this.id)">O</div>
        <div class="white" id="23"></div>
        <div class="black" id="24" onClick="reply_click(this.id)">O</div>
        <div class="white" id="25"></div>
        <div class="black" id="26" onClick="reply_click(this.id)">O</div>
        <div class="white" id="27"></div>

        <!-- 4th -->
        <div class="white" id="30"></div>
        <div class="black" id="31" onClick="reply_click(this.id)"></div>
        <div class="white" id="32"></div>
        <div class="black" id="33" onClick="reply_click(this.id)"></div>
        <div class="white" id="34"></div>
        <div class="black" id="35" onClick="reply_click(this.id)"></div>
        <div class="white" id="36"></div>
        <div class="black" id="37" onClick="reply_click(this.id)"></div>

        <!-- 5th -->
        <div class="black" id="40" onClick="reply_click(this.id)"></div>
        <div class="white" id="41"></div>
        <div class="black" id="42" onClick="reply_click(this.id)"></div>
        <div class="white" id="43"></div>
        <div class="black" id="44" onClick="reply_click(this.id)"></div>
        <div class="white" id="45"></div>
        <div class="black" id="46" onClick="reply_click(this.id)"></div>
        <div class="white" id="47"></div>

        <!-- 6th -->
        <div class="white" id="50"></div>
        <div class="black" id="51" onClick="reply_click(this.id)">X</div>
        <div class="white" id="52"></div>
        <div class="black" id="53" onClick="reply_click(this.id)">X</div>
        <div class="white" id="54"></div>
        <div class="black" id="55" onClick="reply_click(this.id)">X</div>
        <div class="white" id="56"></div>
        <div class="black" id="57" onClick="reply_click(this.id)">X</div>

        <!-- 7th -->
        <div class="black" id="60" onClick="reply_click(this.id)">X</div>
        <div class="white" id="61"></div>
        <div class="black" id="62" onClick="reply_click(this.id)">X</div>
        <div class="white" id="63"></div>
        <div class="black" id="64" onClick="reply_click(this.id)">X</div>
        <div class="white" id="65"></div>
        <div class="black" id="66" onClick="reply_click(this.id)">X</div>
        <div class="white" id="67"></div>

        <!-- 8th -->
        <div class="white" id="70"></div>
        <div class="black" id="71" onClick="reply_click(this.id)">X</div>
        <div class="white" id="72"></div>
        <div class="black" id="73" onClick="reply_click(this.id)">X</div>
        <div class="white" id="74"></div>
        <div class="black" id="75" onClick="reply_click(this.id)">X</div>
        <div class="white" id="76"></div>
        <div class="black" id="77" onClick="reply_click(this.id)">X</div>
    </div>
</center>

<script src="/socket.io/socket.io.js"></script>
<script>
var socket = io();

// listens for when opponent left the game
socket.on("opponentDC", function(msg){
    alert(msg)
    // close the game somehow
    });

// listens for error messages
socket.on("error", function(msg){
    alert(msg);
    });

// fresh board
var game = {
    Player: "N",
    boardstate: 
    [
        [1,0,1,0,1,0,1,0],
        [0,1,0,1,0,1,0,1],
        [1,0,1,0,1,0,1,0],
        [0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0],
        [0,-1,0,-1,0,-1,0,-1],
        [-1,0,-1,0,-1,0,-1,0],
        [0,-1,0,-1,0,-1,0,-1]
    ]};

// who am I
socket.on("playerName", function(msg)
{
    game.Player = msg;
});


// loads checkers board
socket.on("updateBoard", function(msg){
    game.board = msg[0];
    document.getElementById("currentTurn").innerHTML = "It's currently player " + msg[1] + "'s turn"; 
    // run josh's thing that renders the board
    });
    
// listens for the game id
socket.on("gid", function(msg){
    document.getElementById("gid").innerHTML = "Your room ID is: " + msg;
   });


function hideSetup()
{
    document.getElementById("setup").style.display = "none";
    document.getElementById("header").innerHTML = "Checkers game team7";
}

function gameOver()
{
    alert("game over");
}

function startGame(hosting)
{
    if (hosting == "host"){
        socket.emit("gameReq", -1);
    }else {
        var gameID = prompt("please enter the ID of the game that you are joining");
        socket.emit("gameReq", parseInt(gameID));
    }
    
    hideSetup();
}


//globals

var board = [
[1,0,1,0,1,0,1,0],
[0,1,0,1,0,1,0,1],
[1,0,1,0,1,0,1,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,3,0,3,0,3,0,3],
[3,0,3,0,3,0,3,0],
[0,3,0,3,0,3,0,3],
];

var lastHighlightedMoves = [];
var potentiallyEatenPieces = [];

var currentlySelectedPiece;
var pieceWasKinged = false;
var pieceWasEaten = false;

function reply_click(clicked_id)
{
    var row = parseInt(clicked_id);
    row = row < 10? 0 : Math.floor(row / 10);
    var column = parseInt(clicked_id);
    column = column % 10;
    var listOfMoves = [];
    var clickedSquare = document.getElementById(clicked_id);
    
    if(clickedSquare.textContent == "") {

        
        if(clickedSquare.className == "green"){
            movePiece(clickedSquare, row, column);
        }
        
        currentlySelectedPiece = null;
        clearLastHighlightedMoves();
    } else {
        currentlySelectedPiece = clickedSquare;
        listOfMoves = checkR(row, column);
        clearLastHighlightedMoves();

        if(listOfMoves == ""){
            listOfMoves = checkG(row, column);
            for (i = 0; i<listOfMoves.length; i++){
                var temp = listOfMoves[i].toString();
                if(temp.length==1){
                    temp = "0"+temp;
                }
                potentiallyEatenPieces = [];
                document.getElementById(temp).className = "green";
                lastHighlightedMoves.push(temp);
            }
        } else {
            for (i = 0; i<listOfMoves.length/2; i++){
                var temp = listOfMoves[i].toString();
                if(temp.length==1){
                    temp = "0"+temp;
                }
            for (i = listOfMoves.length/2; i<listOfMoves.length; i++){
                potentiallyEatenPieces.push(listOfMoves[i]);
            }
                document.getElementById(temp).className = "green";
                lastHighlightedMoves.push(temp);
            }
        }
        
        
    }
}

//note the row and column are of the location you're moving to
//row1 and col1 are the location of the piece that is moving
function movePiece(clickedSquare, row, column)
{
    clickedSquare.textContent = currentlySelectedPiece.textContent;//make the newly selected square house the "piece"
    currentlySelectedPiece.textContent = ""; //make the old location "empty"
    clickedPieceID = currentlySelectedPiece.id; //get the id of the currently selected piece (the piece, not the square)
    var row1 = parseInt(clickedPieceID); //turn the id into row/column
    row1 = row1 < 10? 0 : Math.floor(row1 / 10);
    var column1 = parseInt(clickedPieceID);
    column1 = column1 % 10;
    board[row][column] = board[row1][column1];//swap board information
    board[row1][column1] = 0;
    checkCoronation(clickedSquare, row, column);
    checkToSeeIfPieceEaten(row1, column1, row, column)
    currentlySelectedPiece = null;
}

//eRow and eColumn are the row and column of the empty square the piece is moving to
//mRow and mColumn are the row and column of the Moving piece's original location
function checkToSeeIfPieceEaten(eRow, eColumn, mRow, mColumn){

    dyingPieceRow = (eRow + mRow)/2;
    dyingPieceColumn = (eColumn + mColumn)/2;
    dyingCoordinates = dyingPieceRow*10 + dyingPieceColumn;

    for(i = 0; i < potentiallyEatenPieces.length; i++){
        if(dyingCoordinates == potentiallyEatenPieces[i]){
            document.getElementById(dyingCoordinates.toString()).textContent = "";
            board[dyingPieceRow][dyingPieceColumn] = 0;
            pieceWasEaten = true;
        }
    }

    potentiallyEatenPieces = []
}

function checkCoronation(clickedSquare, row, column)
{
    if(row == 7 && clickedSquare.textContent == "O"){
        clickedSquare.textContent = "Q";
        board[row][column] = 2;
        pieceWasKinged = true;
    }
    if(row == 0 && clickedSquare.textContent == "X"){
        clickedSquare.textContent = "Z";
        board[row][column] = 4;
        pieceWasKinged = true;
    }
}

function clearLastHighlightedMoves()
{
    for (i = 0; i<lastHighlightedMoves.length; i++){
            document.getElementById(lastHighlightedMoves[i]).className = "black";
        }
    lastHighlightedMoves = [];
}

//given the coordinates of a piece, checks which spaces it can move to that DO NOT involve capturing another piece
function checkG(y, x)
{
        //returns array of regular moves(green fields)
        var type = board[y][x];
        var moves = [];
        var holder = 0;
        if(type==1||type==2){
            //checks forward moves
            if(x>0&&y<7){
                //System.out.print(board[1][2]);
                //System.out.print(y+1);
                if(board[y+1][x-1]==0){
                    moves[holder]=(y+1)*10+x-1;
                    holder+=1;
                }
            }
            if(x<7&&y<7){
                if(board[y+1][x+1]==0){
                    moves[holder]=(y+1)*10+x+1;
                    holder+=1;
                }
            }
            if(type==2){
                if(x>0&&y>0){
                    if(board[y-1][x-1]==0){
                        moves[holder]=(y-1)*10+x-1;
                        holder+=1;
                    }
                }
                if(x<7&&y>0){
                    if(board[y-1][x+1]==0){
                        moves[holder]=(y-1)*10+x+1;
                        holder+=1;
                    }
                }
            }
        }
        else if(type==3||type==4){
            //checks forward moves
            if(x>0&&y<8 && y!=0){
                if(board[y-1][x-1]==0){
                    moves[holder]=(y-1)*10+x-1;
                    holder+=1;
                }
            }
            if(x<7&&y<8 && y!=0){
                if(board[y-1][x+1]==0){
                    moves[holder]=(y-1)*10+x+1;
                    holder+=1;
                }
            }
            if(type==4){
                //checks backwards moves for kingpieces
                if(x>0&&y>=0){
                    if(board[y+1][x-1]==0){
                        moves[holder]=(y+1)*10+x-1;
                        holder+=1;
                    }
                }
                if(x<7&&y>=0){
                    if(board[y+1][x+1]==0){
                        moves[holder]=(y+1)*10+x+1;
                        holder+=1;
                    }
                }
            }
        }
        return moves;
}

//given the coordinates of a piece, checks which spaces it can move to that involve capturing another piece
function checkR(y, x)
{
        //returns array of possible jump moves(red fields)
        var type = board[y][x];
        var moves = [];
        var holder = 0;

        var correspondinglyEatenPieces = [];
        var iterator = 0;

        //alert(type + " " + y + x);
        if(type == 1){
            if(y==6)
                return [];
        }
        if(type == 2){
            if(y == 6 || y == 7){
                //checks backwards moves for kingpieces
                if(x>1&&y>1){
                    if(board[y-1][x-1]>2){
                        if(board[y-2][x-2]==0){
                        moves[holder]=(y-2)*10+x-2;
                        holder++;
                        correspondinglyEatenPieces[iterator]=(y-1)*10+x-1;
                        iterator++;
                    }
                    }
                }
                if(x<6&&y>1){
                    if(board[y-1][x+1]>2){
                        if(board[y-2][x+2]==0){
                        moves[holder]=(y-2)*10+x+2;
                        holder++;
                        correspondinglyEatenPieces[iterator]=(y-1)*10+x+1;
                        iterator++;
                    }
                    }
                }
            
            for(i = 0; i<correspondinglyEatenPieces.length; i++){
                moves.push(correspondinglyEatenPieces[i]);
            }
            return moves;
            }
        }

        if(type == 3){
            if(y==1){
                return [];
            }
        }

        if(type == 4){
            if(y ==1 || y == 0){
                if(board[y+1][x-1]<2){
                    if(board[y+2][x-2]==0){
                        moves[holder]=(y+2)*10+x-2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y+1)*10+x-1;
                        iterator++;
                    }
                }
            }
            if(x<6&&y<6){
                if(board[y+1][x+1]<2){
                    if(board[y+2][x+2]==0){
                        moves[holder]=(y+2)*10+x+2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y+1)*10+x+1;
                        iterator++;
                    }
                }
            }
            for(i = 0; i<correspondinglyEatenPieces.length; i++){
                moves.push(correspondinglyEatenPieces[i]);
            }
            return moves;
        }

        if(type==1||type==2){
            //checks forward moves
            if(x>=1&&y<6){
                if(board[y+1][x-1]>2){
                    if(board[y+2][x-2]==0){
                        moves[holder]=(y+2)*10+x-2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y+1)*10+x-1;
                        iterator++;
                    }
                }
            }
            if(x<6&&y<6){
                if(board[y+1][x+1]>2){
                    if(board[y+2][x+2]==0){
                        moves[holder]=(y+2)*10+x+2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y+1)*10+x+1;
                        iterator++;
                    }
                }
            }
            if(type==2){
                //checks backwards moves for kingpieces
                if(x>1&&y>1){
                    if(board[y-1][x-1]>2){
                        if(board[y-2][x-2]==0){
                        moves[holder]=(y-2)*10+x-2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y-1)*10+x-1;
                        iterator++;
                    }
                    }
                }
                if(x<6&&y>1){
                    if(board[y-1][x+1]>2){
                        if(board[y-2][x+2]==0){
                        moves[holder]=(y-2)*10+x+2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y-1)*10+x+1;
                        iterator++;
                    }
                    }
                }
            }
        }
        else if(type==3||type==4){
            //checks forward moves
            if(x>1&&y<8){
                if(board[y-1][x-1]<3&&board[y-1][x-1]>0){
                    if(board[y-2][x-2]==0){
                        moves[holder]=(y-2)*10+x-2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y-1)*10+x-1;
                        iterator++;
                    }
                }
            }
            if(x<6&&y<8){
                if(board[y-1][x+1]<3&&board[y-1][x+1]>0){
                    if(board[y-2][x+2]==0){
                        moves[holder]=(y-2)*10+x+2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y-1)*10+x+1;
                        iterator++;
                    }
                }
            }
            //checks backwards moves for kingpieces
            if(type==4){
                if(x>1&&y>1){
                    if(board[y+1][x-1]<3&&board[y-1][x-1]>0){
                        if(board[y-2][x-2]==0){
                        moves[holder]=(y+2)*10+x-2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y+1)*10+x-1;
                        iterator++;
                    }
                    }
                }
                if(x<6&&y>1){
                    if(board[y+1][x+1]<3&&board[y-1][x+1]>0){
                        if(board[y-2][x+2]==0){
                        moves[holder]=(y+2)*10+x+2;
                        holder+=1;
                        correspondinglyEatenPieces[iterator]=(y+1)*10+x+1;
                        iterator++;
                    }
                    }
                }
            }
        }

        for(i = 0; i<correspondinglyEatenPieces.length; i++){
            moves.push(correspondinglyEatenPieces[i]);
        }
        return moves;
}


</script>

</body>
</html>

